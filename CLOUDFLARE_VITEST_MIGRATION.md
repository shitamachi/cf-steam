# Cloudflare Workers Vitest é›†æˆè¿ç§»æ€»ç»“

## ğŸ“‹ è¿ç§»æ¦‚è¿°

æœ¬é¡¹ç›®å·²æˆåŠŸè¿ç§»åˆ°ä½¿ç”¨ Cloudflare Workers Vitest é›†æˆç¯å¢ƒã€‚ä»¥ä¸‹æ˜¯è¿ç§»çš„ä¸»è¦å˜æ›´å’Œæ”¹è¿›ï¼š

## âœ… å·²å®Œæˆçš„è¿ç§»ä»»åŠ¡

### 1. æµ‹è¯•ç¯å¢ƒè®¾ç½®è¿ç§» (`test/setup.ts`)
- âœ… **ç§»é™¤ Node.js ä¾èµ–**: åˆ é™¤äº† `fs`ã€`path` å’Œ `node-fetch` æ¨¡å—
- âœ… **Workers ç¯å¢ƒé€‚é…**: ä½¿ç”¨åŸç”Ÿ Workers `fetch` API
- âœ… **å†…å­˜ç¼“å­˜ç³»ç»Ÿ**: å®ç°äº†åŸºäºå†…å­˜çš„æµ‹è¯•æ•°æ®ç¼“å­˜ï¼Œæ›¿ä»£æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨
- âœ… **ç¯å¢ƒæ£€æµ‹**: æ·»åŠ äº† Workers ç¯å¢ƒç‰¹æ€§æ£€æµ‹ï¼ˆHTMLRewriter ç­‰ï¼‰
- âœ… **åå¤‡æœºåˆ¶**: ä¸ºç½‘ç»œå¤±è´¥æä¾›æ¨¡æ‹Ÿæ•°æ®åå¤‡

### 2. SteamService æµ‹è¯•è¿ç§» (`test/steam-service.test.ts`)
- âœ… **Workers å…¼å®¹**: æ›´æ–°æµ‹è¯•ä»¥ä½¿ç”¨ Workers ç¯å¢ƒçš„ `fetch` API
- âœ… **æ¨¡æ‹Ÿä¼˜åŒ–**: ä½¿ç”¨ `vi.stubGlobal()` è¿›è¡Œ Workers ç¯å¢ƒçš„æ¨¡æ‹Ÿ
- âœ… **æµ‹è¯•è¦†ç›–**: å¢åŠ äº† Workers ç¯å¢ƒç‰¹æ€§æµ‹è¯•
- âœ… **é”™è¯¯å¤„ç†**: æ”¹è¿›äº†ç½‘ç»œé”™è¯¯å’Œä¸å­˜åœ¨æ¸¸æˆçš„æµ‹è¯•åœºæ™¯
- âœ… **æ•°æ®éªŒè¯**: å¢å¼ºäº†æ•°æ®ç»“æ„éªŒè¯æµ‹è¯•

### 3. Steam çˆ¬è™«æµ‹è¯•è¿ç§» (`test/test-steam-scraper.test.ts`)
- âœ… **ç¯å¢ƒé€‚é…**: å®Œå…¨é€‚é… Workers ç¯å¢ƒ
- âœ… **æ¨¡æ‹Ÿæ•°æ®**: åˆ›å»ºäº†è¯¦ç»†çš„ HTML æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆå‡½æ•°
- âœ… **æµ‹è¯•ä¼˜åŒ–**: ç®€åŒ–äº†æµ‹è¯•é€»è¾‘ï¼Œæé«˜äº†å¯é æ€§
- âœ… **æ€§èƒ½æµ‹è¯•**: ä¿ç•™äº†æ•°æ®å®Œæ•´æ€§åˆ†æåŠŸèƒ½
- âœ… **Workers ç‰¹æ€§**: æ·»åŠ äº† Workers ç¯å¢ƒç‰¹æœ‰çš„æµ‹è¯•

### 4. Vitest é…ç½®ä¼˜åŒ– (`vitest.config.ts`)
- âœ… **Workers æ± é…ç½®**: ä½¿ç”¨ `@cloudflare/vitest-pool-workers`
- âœ… **Wrangler é›†æˆ**: æ­£ç¡®é…ç½®äº† wrangler.jsonc è·¯å¾„
- âœ… **å…¼å®¹æ€§æ ‡å¿—**: è®¾ç½®äº†é€‚å½“çš„ Workers å…¼å®¹æ€§æ ‡å¿—
- âœ… **è¶…æ—¶é…ç½®**: è°ƒæ•´äº†é€‚åˆç½‘ç»œè¯·æ±‚çš„è¶…æ—¶è®¾ç½®

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯å˜æ›´

### ä» Node.js åˆ° Workers ç¯å¢ƒ
```typescript
// ä¹‹å‰ (Node.js)
import fs from "fs"
import fetch from "node-fetch"

// ç°åœ¨ (Workers)
// ä½¿ç”¨åŸç”Ÿ Workers fetch API å’Œå†…å­˜å­˜å‚¨
const testDataCache = new Map<string, string>()
```

### æ¨¡æ‹Ÿæ–¹å¼æ”¹è¿›
```typescript
// ä¹‹å‰
vi.spyOn(global, "fetch")

// ç°åœ¨ (Workers å…¼å®¹)
vi.stubGlobal('fetch', mockFetch)
```

### ç¯å¢ƒæ£€æµ‹
```typescript
// æ–°å¢ Workers ç¯å¢ƒç‰¹æ€§æ£€æµ‹
const hasHTMLRewriter = typeof HTMLRewriter !== "undefined"
const hasResponse = typeof Response !== "undefined"
```

## ğŸ“ æ–°å¢æ–‡ä»¶ç»“æ„

```
test/
â”œâ”€â”€ setup.ts                 # âœ… Workers ç¯å¢ƒè®¾ç½®
â”œâ”€â”€ steam-service.test.ts     # âœ… SteamService æµ‹è¯• (Workers é€‚é…)
â”œâ”€â”€ test-steam-scraper.test.ts # âœ… Steam çˆ¬è™«æµ‹è¯• (Workers é€‚é…)
â”œâ”€â”€ basic.test.ts            # âœ… åŸºç¡€ç¯å¢ƒæµ‹è¯•
â”œâ”€â”€ simple.test.ts           # âœ… ç®€å•éªŒè¯æµ‹è¯•
â””â”€â”€ steam-data-example.json  # ğŸ“„ æµ‹è¯•æ•°æ®ç¤ºä¾‹
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pnpm test test/steam-service.test.ts

# è¿è¡Œ Workers ç¯å¢ƒåŸºç¡€æµ‹è¯•
pnpm test test/basic.test.ts
```

### å¼€å‘æ¨¡å¼
```bash
# å¯åŠ¨ Workers å¼€å‘æœåŠ¡å™¨
pnpm cf-dev

# å¯åŠ¨æµ‹è¯•ç›‘æ§æ¨¡å¼
pnpm test --watch
```

## ğŸ” æµ‹è¯•ç‰¹æ€§

### Workers ç¯å¢ƒç‰¹æ€§æµ‹è¯•
- âœ… HTMLRewriter å¯ç”¨æ€§æ£€æµ‹
- âœ… Workers fetch API éªŒè¯
- âœ… ç¯å¢ƒå˜é‡è®¿é—®æµ‹è¯•
- âœ… Workers å…¨å±€å¯¹è±¡æ£€æŸ¥

### ç½‘ç»œè¯·æ±‚æ¨¡æ‹Ÿ
- âœ… HTTP å“åº”æ¨¡æ‹Ÿ
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†
- âœ… 404 é”™è¯¯æ¨¡æ‹Ÿ
- âœ… è¶…æ—¶å¤„ç†

### æ•°æ®éªŒè¯
- âœ… GameSchema ç»“æ„éªŒè¯
- âœ… æ•°æ®å®Œæ•´æ€§åˆ†æ
- âœ… ç±»å‹å®‰å…¨æ£€æŸ¥
- âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜æœºåˆ¶
- ğŸ“ˆ å†…å­˜ç¼“å­˜æ›¿ä»£æ–‡ä»¶ç³»ç»Ÿ
- ğŸ“ˆ æµ‹è¯•æ•°æ®å¤ç”¨
- ğŸ“ˆ å‡å°‘ç½‘ç»œè¯·æ±‚

### æµ‹è¯•å¹¶å‘
- ğŸ“ˆ æ”¯æŒå¹¶å‘æµ‹è¯•æ‰§è¡Œ
- ğŸ“ˆ Workers æ± éš”ç¦»
- ğŸ“ˆ èµ„æºæ¸…ç†è‡ªåŠ¨åŒ–

## ğŸ› å·²çŸ¥é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### Vite ç‰ˆæœ¬å…¼å®¹æ€§
- **é—®é¢˜**: Vite 7.x ä¸å½“å‰ Node.js ç‰ˆæœ¬çš„ crypto.hash å…¼å®¹æ€§é—®é¢˜
- **ä¸´æ—¶è§£å†³æ–¹æ¡ˆ**: é™çº§åˆ° Vite 5.x
- **çŠ¶æ€**: éœ€è¦ç­‰å¾…ä¾èµ–åº“æ›´æ–°

### HTMLRewriter æ¨¡æ‹Ÿ
- **è¯´æ˜**: åœ¨æµ‹è¯•ç¯å¢ƒä¸­ HTMLRewriter å¯èƒ½ä¸å¯ç”¨
- **è§£å†³æ–¹æ¡ˆ**: SteamService å·²å®ç°è‡ªåŠ¨å›é€€åˆ°æ­£åˆ™è¡¨è¾¾å¼è§£æ
- **çŠ¶æ€**: æ­£å¸¸å·¥ä½œ

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

1. **MSW é›†æˆ**: æ·»åŠ  Mock Service Worker è¿›è¡Œæ›´çœŸå®çš„ç½‘ç»œæ¨¡æ‹Ÿ
2. **E2E æµ‹è¯•**: å®ç°ç«¯åˆ°ç«¯æµ‹è¯•è¦†ç›–
3. **æ€§èƒ½åŸºå‡†**: å»ºç«‹æ€§èƒ½æµ‹è¯•åŸºå‡†
4. **CI/CD é›†æˆ**: é…ç½® GitHub Actions çš„ Workers æµ‹è¯•ç¯å¢ƒ

## ğŸ“š å‚è€ƒèµ„æ–™

- [Cloudflare Workers Vitest Integration](https://developers.cloudflare.com/workers/testing/vitest-integration/)
- [Vitest Workers Pool Documentation](https://vitest.dev/guide/workspace.html#workers-pool)
- [Workers Runtime APIs](https://developers.cloudflare.com/workers/runtime-apis/)

---

**è¿ç§»å®Œæˆæ—¶é—´**: 2025å¹´1æœˆ7æ—¥  
**è¿ç§»çŠ¶æ€**: âœ… å®Œæˆ  
**æµ‹è¯•çŠ¶æ€**: ğŸŸ¡ éœ€è¦ç¯å¢ƒè°ƒè¯•ï¼ˆVite ç‰ˆæœ¬é—®é¢˜ï¼‰  
**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæ•´ 